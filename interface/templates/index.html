<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drone Location Tracker</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="container">
    <h1>Drone Location Tracker</h1>
    
    <!-- User Location Controls -->
    <div class="section">
      <h2>User Location Tracking</h2>
      <div class="controls">
        <button id="startBtn" onclick="startLocationTracking()">Start User Tracking</button>
        <button id="stopBtn" onclick="stopLocationTracking()" disabled>Stop User Tracking</button>
      </div>
      <p id="userStatus">ğŸ“ Click "Start User Tracking" to begin. Phone GPS2IP preferred (port 11123), laptop GPS as fallback.</p>
    </div>

    <!-- Drone Telemetry Controls -->
    <div class="section">
      <h2>Drone Telemetry</h2>
      <div class="controls">
        <button id="droneStartBtn" onclick="startDroneTracking()">Start Drone Tracking</button>
        <button id="droneStopBtn" onclick="stopDroneTracking()" disabled>Stop Drone Tracking</button>
      </div>
      <p id="droneStatus">Click "Start Drone Tracking" to begin monitoring drone location.</p>
    </div>

    <!-- Distance and Status Display -->
    <div class="section">
      <h2>Live Status</h2>
      <div id="statusDisplay">
        <div class="status-item">
          <strong>User Location:</strong> <span id="userLocation">Not available</span>
        </div>
        <div class="status-item">
          <strong>GPS Source:</strong> <span id="gpsSource">No GPS</span>
        </div>
        <div class="status-item">
          <strong>Drone Location:</strong> <span id="droneLocation">Not available</span>
        </div>
        <div class="status-item">
          <strong>Distance:</strong> <span id="distance">Not calculated</span>
        </div>
        <div class="status-item">
          <strong>Follow Mode:</strong> <span id="followMode">Inactive</span>
        </div>
      </div>
    </div>

    <!-- Comprehensive Drone Metrics -->
    <div class="section">
      <h2>ğŸš Drone Telemetry & Metrics</h2>
      <div id="droneMetricsDisplay">
        <div class="metrics-grid">
          <!-- Connection & Status -->
          <div class="metric-group">
            <h3>Connection & Status</h3>
            <div class="metric-item">
              <strong>Connection:</strong> <span id="connectionStatus">Not Connected</span>
            </div>
            <div class="metric-item">
              <strong>Armed:</strong> <span id="armedStatus">Unknown</span>
            </div>
            <div class="metric-item">
              <strong>Ready to Arm:</strong> <span id="armableStatus">Unknown</span>
            </div>
            <div class="metric-item">
              <strong>Flight Mode:</strong> <span id="flightMode">Unknown</span>
            </div>
            <div class="metric-item">
              <strong>System Status:</strong> <span id="systemStatus">Unknown</span>
            </div>
          </div>

          <!-- Altitude & Position -->
          <div class="metric-group">
            <h3>Altitude & Position</h3>
            <div class="metric-item">
              <strong>Relative Altitude:</strong> <span id="altitudeRelative">0 m</span>
            </div>
            <div class="metric-item">
              <strong>Absolute Altitude:</strong> <span id="altitudeAbsolute">0 m</span>
            </div>
            <div class="metric-item">
              <strong>Latitude:</strong> <span id="droneLatitude">0.000000</span>
            </div>
            <div class="metric-item">
              <strong>Longitude:</strong> <span id="droneLongitude">0.000000</span>
            </div>
          </div>

          <!-- Battery Information -->
          <div class="metric-group">
            <h3>Battery Information</h3>
            <div class="metric-item">
              <strong>Battery Level:</strong> <span id="batteryLevel">0%</span>
            </div>
            <div class="metric-item">
              <strong>Battery Voltage:</strong> <span id="batteryVoltage">0.0 V</span>
            </div>
            <div class="metric-item">
              <strong>Battery Current:</strong> <span id="batteryCurrent">0.0 A</span>
            </div>
            <div class="metric-item">
              <strong>Battery Status:</strong> <span id="batteryStatus">Unknown</span>
            </div>
          </div>

          <!-- GPS Information -->
          <div class="metric-group">
            <h3>GPS Information</h3>
            <div class="metric-item">
              <strong>GPS Fix:</strong> <span id="gpsFixType">No Fix</span>
            </div>
            <div class="metric-item">
              <strong>Satellites:</strong> <span id="gpsSatellites">0</span>
            </div>
            <div class="metric-item">
              <strong>GPS EPH:</strong> <span id="gpsEph">0</span>
            </div>
            <div class="metric-item">
              <strong>GPS EPV:</strong> <span id="gpsEpv">0</span>
            </div>
          </div>

          <!-- Attitude (Orientation) -->
          <div class="metric-group">
            <h3>Attitude (Orientation)</h3>
            <div class="metric-item">
              <strong>Pitch:</strong> <span id="pitchAngle">0.0Â°</span>
            </div>
            <div class="metric-item">
              <strong>Roll:</strong> <span id="rollAngle">0.0Â°</span>
            </div>
            <div class="metric-item">
              <strong>Yaw:</strong> <span id="yawAngle">0.0Â°</span>
            </div>
          </div>

          <!-- Speed Information -->
          <div class="metric-group">
            <h3>Speed Information</h3>
            <div class="metric-item">
              <strong>Ground Speed:</strong> <span id="groundSpeed">0.0 m/s</span>
            </div>
            <div class="metric-item">
              <strong>Air Speed:</strong> <span id="airSpeed">0.0 m/s</span>
            </div>
            <div class="metric-item">
              <strong>Last Heartbeat:</strong> <span id="lastHeartbeat">Never</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Drone Follow Controls -->
    <div class="section">
      <h2>Drone Follow Mode</h2>
      <div class="controls">
        <div class="input-group">
          <label for="elevation">Elevation (m):</label>
          <input type="number" id="elevation" min="5" max="100" value="20">
          <label for="groundDistance">Ground Distance (m):</label>
          <input type="number" id="groundDistance" min="5" max="50" value="10">
        </div>
        <div class="button-group">
          <button id="followStartBtn" onclick="startDroneFollow()">Start Following</button>
          <button id="followStopBtn" onclick="stopDroneFollow()" disabled>Stop Following</button>
          <button id="homeBtn" onclick="droneHome()" class="home-btn">HOME (Land)</button>
        </div>
      </div>
      <p id="followStatus">Configure elevation and distance, then click "Start Following" to begin autonomous tracking.</p>
    </div>

    <!-- GoPro Integration -->
    <div class="section">
      <h2>ğŸ“¹ GoPro Camera Integration</h2>
      
      <!-- GoPro Connection -->
      <div class="controls">
        <div class="input-group">
          <label for="goproIP">GoPro IP:</label>
          <input type="text" id="goproIP" value="10.5.5.9" placeholder="10.5.5.9">
          <button id="connectGoproBtn" onclick="connectGopro()">ğŸ”— Connect GoPro</button>
          <button id="disconnectGoproBtn" onclick="disconnectGopro()" disabled>âŒ Disconnect</button>
        </div>
        <div class="gopro-status">
          <span id="goproStatus">ğŸ“· GoPro Disconnected</span>
        </div>
      </div>
      
      <!-- GoPro Controls -->
      <div class="controls">
        <div class="button-group">
          <button id="startStreamBtn" onclick="startGoproStream()" disabled>ğŸ“¡ Start Stream</button>
          <button id="stopStreamBtn" onclick="stopGoproStream()" disabled>â¹ï¸ Stop Stream</button>
          <button id="startRecordBtn" onclick="startGoproRecord()" disabled>ğŸ”´ Start Recording</button>
          <button id="stopRecordBtn" onclick="stopGoproRecord()" disabled>â¹ï¸ Stop Recording</button>
          <button id="takePhotoBtn" onclick="takeGoproPhoto()" disabled>ğŸ“¸ Take Photo</button>
        </div>
        <div class="recording-status">
          <span id="recordingStatus">âš« Not Recording</span>
        </div>
      </div>
      
      <!-- GoPro Live Feed with Human Detection -->
      <div class="controls" id="goproFeedContainer" style="display: none;">
        <div class="video-container">
          <h3>ğŸ“¹ GoPro Live Feed with Human Detection</h3>
          <canvas id="goproFeed" style="width: 100%; max-width: 640px; height: auto; border: 2px solid #0066cc; border-radius: 8px; background: #000;"></canvas>
          <div class="stream-status">
            <span id="streamStatus">ğŸ“¡ Stream Offline</span>
            <span id="detectionCount" style="margin-left: 20px;">ğŸ‘¥ Persons: 0</span>
          </div>
        </div>
        
        <!-- Human Detection Controls (integrated with GoPro) -->
        <div class="detection-controls" style="margin-top: 15px;">
          <div class="button-group">
            <button id="toggleGoproBoxesBtn" onclick="toggleGoproBoundingBoxes()">ğŸ‘ï¸ Toggle Detection Boxes</button>
            <button id="lockPersonBtn" onclick="lockOnNextPerson()" disabled>ğŸ”’ Lock onto Person</button>
            <button id="unlockPersonBtn" onclick="unlockGoproPerson()" disabled>ğŸ”“ Unlock Person</button>
          </div>
          <div class="detection-status">
            <span id="goproDetectionStatus">ğŸ¯ Detection Active</span>
            <span id="lockedPersonStatus" style="margin-left: 20px;">ğŸ”’ No person locked</span>
          </div>
        </div>
      </div>
      
      <!-- Auto-Tracking Controls -->
      <div class="controls">
        <div class="button-group">
          <button id="enableAutoTrackBtn" onclick="enableAutoTracking()">ğŸ¯ Enable Auto-Tracking</button>
          <button id="disableAutoTrackBtn" onclick="disableAutoTracking()" disabled>ğŸš« Disable Auto-Tracking</button>
        </div>
        <div class="tracking-status">
          <span id="autoTrackStatus">ğŸ¯ Auto-Tracking Disabled</span>
        </div>
      </div>
      
      <!-- Manual Gimbal Controls -->
      <div class="controls">
        <div class="input-group">
          <label for="gimbalTilt">Gimbal Tilt:</label>
          <input type="range" id="gimbalTilt" min="-90" max="30" value="0" oninput="updateGimbalTilt(this.value)">
          <span id="tiltValue">0Â°</span>
          <button id="centerGimbalBtn" onclick="centerGimbal()">ğŸ¯ Center Gimbal</button>
        </div>
      </div>
    </div>

    <!-- Basic Drone Controls -->
    <div class="section">
      <h2>Basic Drone Controls</h2>
      <div class="controls">
        <div class="button-group">
          <button id="disableSafetyBtn" onclick="disableSafety()" class="safety-btn">ğŸ”“ Disable Safety (SITL)</button>
          <button id="takeoffBtn" onclick="droneTakeoff()" class="takeoff-btn">ğŸš TAKEOFF (5 feet)</button>
          <button id="landBtn" onclick="droneLand()" class="land-btn">ğŸ›¬ LAND</button>
        </div>
      </div>
      <p id="basicControlStatus">Use these controls for basic takeoff and landing operations.</p>
    </div>

    <!-- System Logs -->
    <div class="section">
      <h2>System Logs</h2>
      <div class="controls">
        <div class="button-group">
          <button id="clearLogsBtn" onclick="clearSystemLogs()" class="clear-btn">ğŸ—‘ï¸ Clear Logs</button>
          <label>
            <input type="checkbox" id="autoScrollLogs" checked> Auto-scroll logs
          </label>
        </div>
      </div>
      <div id="logDisplay" class="log-display">
        <div class="log-message">System ready - logs will appear here...</div>
      </div>
    </div>
  </div>

  <!-- JavaScript is now external -->
  <script src="{{ url_for('static', filename='scripts.js') }}?v={{ range(1000, 9999) | random }}"></script>
</body>
</html>
