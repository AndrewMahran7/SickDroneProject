<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drone Location Tracker</title>

  <style>
    /* Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
      padding: 10px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    h1 {
      text-align: center;
      color: #2c3e50;
      font-size: 2rem;
      margin-bottom: 30px;
      font-weight: 700;
    }
    
    h2 {
      color: #34495e;
      font-size: 1.3rem;
      margin-bottom: 15px;
      border-left: 4px solid #3498db;
      padding-left: 15px;
      font-weight: 600;
    }
    
    /* Section Styles */
    .section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
    }
    
    .controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: center;
    }
    
    /* Input Styles */
    .input-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .input-group label {
      font-weight: 600;
      color: #2c3e50;
      font-size: 0.95rem;
    }
    
    .input-group input[type="number"] {
      width: 80px;
      padding: 10px 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .input-group input[type="number"]:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
    }
    
    .input-group input[type="checkbox"] {
      transform: scale(1.2);
      margin-right: 8px;
    }
    
    /* Button Styles */
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }
    
    button {
      padding: 12px 20px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 140px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      background-color: #bdc3c7 !important;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }
    
    /* Button Color Schemes */
    #startBtn, #droneStartBtn, #followStartBtn {
      background: linear-gradient(45deg, #27ae60, #2ecc71);
      color: white;
    }
    
    #stopBtn, #droneStopBtn, #followStopBtn {
      background: linear-gradient(45deg, #e74c3c, #c0392b);
      color: white;
    }
    
    .home-btn {
      background: linear-gradient(45deg, #f39c12, #e67e22);
      color: white;
    }
    
    .takeoff-btn {
      background: linear-gradient(45deg, #3498db, #2980b9);
      color: white;
    }
    
    .land-btn {
      background: linear-gradient(45deg, #9b59b6, #8e44ad);
      color: white;
    }
    
    .clear-btn {
      background: linear-gradient(45deg, #e74c3c, #c0392b);
      color: white;
    }
    
    /* Status Displays */
    .status-item {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      border-left: 4px solid #3498db;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .status-item strong {
      color: #2c3e50;
      display: inline-block;
      min-width: 120px;
    }
    
    #statusDisplay {
      background: #ecf0f1;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #bdc3c7;
    }
    
    #userStatus, #droneStatus, #followStatus, #basicControlStatus {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
    }
    
    /* Status Message Styles */
    .status-sending {
      background-color: #d5f4e6;
      color: #27ae60;
      border: 2px solid #2ecc71;
    }
    
    .status-stopped {
      background-color: #fadbd8;
      color: #e74c3c;
      border: 2px solid #c0392b;
    }
    
    .status-error {
      background-color: #fdeaa7;
      color: #f39c12;
      border: 2px solid #e67e22;
    }
    
    .status-success {
      background-color: #d5f4e6;
      color: #27ae60;
      border: 2px solid #2ecc71;
    }
    
    .status-warning {
      background-color: #fff3cd;
      color: #856404;
      border: 2px solid #ffeaa7;
    }
    
    /* Camera Status */
    .camera-status {
      margin-top: 10px;
      text-align: center;
    }
    
    #cameraStatus {
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
      display: inline-block;
    }
    
    /* Log Display */
    .log-display {
      max-height: 300px;
      overflow-y: auto;
      background: #1a1a1a;
      border-radius: 8px;
      padding: 15px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 0.85rem;
      border: 2px solid #333;
    }
    
    .log-message {
      color: #e8e8e8;
      margin: 3px 0;
      padding: 2px 0;
      word-wrap: break-word;
      line-height: 1.4;
    }
    
    .log-message.INFO { color: #2ecc71; }
    .log-message.WARNING { color: #f39c12; }
    .log-message.ERROR { color: #e74c3c; }
    .log-message.SUCCESS { color: #00e676; }
    
    .log-message.DRONE { border-left: 3px solid #3498db; padding-left: 8px; }
    .log-message.FOLLOW { border-left: 3px solid #9b59b6; padding-left: 8px; }
    .log-message.GIMBAL { border-left: 3px solid #f39c12; padding-left: 8px; }
    .log-message.USER { border-left: 3px solid #2ecc71; padding-left: 8px; }
    .log-message.SYSTEM { border-left: 3px solid #95a5a6; padding-left: 8px; }
    
    /* Camera Interface Styles */
    .camera-container {
      position: relative;
      max-width: 800px;
      margin: 20px auto;
      border: 2px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      background: #000;
    }

    #cameraFeed {
      width: 100%;
      height: auto;
      display: block;
    }

    .camera-placeholder {
      padding: 80px 20px;
      text-align: center;
      color: #666;
      font-size: 16px;
    }

    .detection-status {
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .status-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: white;
      border-radius: 5px;
      border: 1px solid #ddd;
    }

    .person-list {
      margin: 15px 0;
      max-height: 200px;
      overflow-y: auto;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 10px;
    }

    .person-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      transition: all 0.3s ease;
    }

    .person-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .person-item.locked {
      border-color: #e74c3c;
      background: #fdedec;
    }

    .person-item .person-info {
      font-weight: 600;
      color: #2c3e50;
    }

    .person-item .lock-btn {
      padding: 6px 12px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .person-item .lock-btn.unlock {
      background: #e74c3c;
      color: white;
    }

    .person-item .lock-btn.lock {
      background: #27ae60;
      color: white;
    }

    .tracking-controls {
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
    }

    .tracking-info {
      margin-top: 15px;
      padding: 12px;
      background: #e3f2fd;
      border-radius: 6px;
      font-size: 14px;
      color: #1565c0;
    }

    #cameraStatus {
      margin-top: 15px;
      padding: 12px;
      text-align: center;
      font-style: italic;
      color: #666;
    }
    
    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      
      .container {
        padding: 15px;
        border-radius: 10px;
      }
      
      h1 {
        font-size: 1.6rem;
        margin-bottom: 20px;
      }
      
      h2 {
        font-size: 1.1rem;
        margin-bottom: 12px;
      }
      
      .section {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .input-group {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
      
      .input-group label {
        font-size: 0.9rem;
      }
      
      .input-group input[type="number"] {
        width: 100px;
        font-size: 1.1rem;
        padding: 12px;
      }
      
      .button-group {
        flex-direction: column;
        width: 100%;
      }
      
      button {
        width: 100%;
        min-width: unset;
        padding: 15px 20px;
        font-size: 1.1rem;
      }
      
      .status-item strong {
        min-width: unset;
        display: block;
        margin-bottom: 5px;
      }
      
      .log-display {
        font-size: 0.8rem;
        max-height: 250px;
      }
      
      .camera-container {
        max-width: 100%;
        margin: 15px 0;
      }
      
      .camera-placeholder {
        padding: 60px 15px;
        font-size: 14px;
      }
      
      .status-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .status-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }
      
      .person-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .person-item .lock-btn {
        align-self: flex-end;
      }
    }
    
    /* Small Phone Responsiveness */
    @media (max-width: 480px) {
      .container {
        padding: 10px;
      }
      
      h1 {
        font-size: 1.4rem;
      }
      
      h2 {
        font-size: 1rem;
        padding-left: 10px;
      }
      
      .section {
        padding: 12px;
      }
      
      button {
        padding: 14px 16px;
        font-size: 1rem;
      }
      
      .input-group input[type="number"] {
        width: 90px;
      }
    }
    
    /* Large Desktop Responsiveness */
    @media (min-width: 1200px) {
      .container {
        padding: 30px;
      }
      
      h1 {
        font-size: 2.4rem;
      }
      
      .section {
        padding: 25px;
      }
      
      .input-group {
        flex-direction: row;
      }
      
      .button-group {
        flex-direction: row;
      }
      
      button {
        min-width: 160px;
      }
    }
    
    /* Landscape Orientation on Mobile */
    @media (max-width: 768px) and (orientation: landscape) {
      .button-group {
        flex-direction: row;
        flex-wrap: wrap;
      }
      
      button {
        flex: 1;
        min-width: 120px;
        max-width: 200px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Drone Location Tracker</h1>
    
    <!-- User Location Controls -->
    <div class="section">
      <h2>User Location Tracking</h2>
      <div class="controls">
        <button id="startBtn" onclick="startLocationTracking()">Start User Tracking</button>
        <button id="stopBtn" onclick="stopLocationTracking()" disabled>Stop User Tracking</button>
      </div>
      <p id="userStatus">üìç Click "Start User Tracking" to begin. Phone GPS2IP preferred (port 11123), laptop GPS as fallback.</p>
    </div>

    <!-- Drone Telemetry Controls -->
    <div class="section">
      <h2>Drone Telemetry</h2>
      <div class="controls">
        <button id="droneStartBtn" onclick="startDroneTracking()">Start Drone Tracking</button>
        <button id="droneStopBtn" onclick="stopDroneTracking()" disabled>Stop Drone Tracking</button>
      </div>
      <p id="droneStatus">Click "Start Drone Tracking" to begin monitoring drone location.</p>
    </div>

    <!-- Distance and Status Display -->
    <div class="section">
      <h2>Live Status</h2>
      <div id="statusDisplay">
        <div class="status-item">
          <strong>User Location:</strong> <span id="userLocation">Not available</span>
        </div>
        <div class="status-item">
          <strong>GPS Source:</strong> <span id="gpsSource">No GPS</span>
        </div>
        <div class="status-item">
          <strong>Drone Location:</strong> <span id="droneLocation">Not available</span>
        </div>
        <div class="status-item">
          <strong>Distance:</strong> <span id="distance">Not calculated</span>
        </div>
        <div class="status-item">
          <strong>Follow Mode:</strong> <span id="followMode">Inactive</span>
        </div>
      </div>
    </div>

    <!-- Drone Follow Controls -->
    <div class="section">
      <h2>Drone Follow Mode</h2>
      <div class="controls">
        <div class="input-group">
          <label for="elevation">Elevation (m):</label>
          <input type="number" id="elevation" min="5" max="100" value="20">
          <label for="groundDistance">Ground Distance (m):</label>
          <input type="number" id="groundDistance" min="5" max="50" value="10">
        </div>
        <div class="button-group">
          <button id="followStartBtn" onclick="startDroneFollow()">Start Following</button>
          <button id="followStopBtn" onclick="stopDroneFollow()" disabled>Stop Following</button>
          <button id="homeBtn" onclick="droneHome()" class="home-btn">HOME (Land)</button>
        </div>
      </div>
      <p id="followStatus">Configure elevation and distance, then click "Start Following" to begin autonomous tracking.</p>
    </div>

    <!-- Human Detection & Tracking -->
    <div class="section">
      <h2>üìπ Human Detection & Tracking</h2>
      
      <!-- Camera Controls -->
      <div class="controls">
        <div class="button-group">
          <button id="restartCameraBtn" onclick="restartCamera()">ÔøΩ Restart Camera</button>
          <button id="toggleBoxesBtn" onclick="toggleBoundingBoxes()">üëÅÔ∏è Toggle Boxes</button>
        </div>
        <div class="camera-status">
          <span id="cameraStatus">ÔøΩ Live camera stream active</span>
        </div>
      </div>
      
      <!-- Live Camera Feed -->
      <div class="camera-container">
        <img id="cameraFeed" src="" alt="Live camera feed">
        <div id="cameraPlaceholder" class="camera-placeholder" style="display: none;">
          <p>üì∑ Camera initializing...</p>
        </div>
      </div>
      
      <!-- Detection Status -->
      <div class="detection-status">
        <div class="status-grid">
          <div class="status-info">
            <strong>Humans Detected:</strong> <span id="detectionCount">0</span>
          </div>
          <div class="status-info">
            <strong>Locked Person:</strong> <span id="lockedPerson">None</span>
          </div>
          <div class="status-info">
            <strong>Bounding Boxes:</strong> <span id="boxStatus">ON</span>
          </div>
        </div>
      </div>
      
      <!-- Person Selection -->
      <div id="personList" class="person-list">
        <p>No persons detected</p>
      </div>
      
      <!-- Drone Tracking Controls -->
      <div class="tracking-controls">
        <div class="button-group">
          <button id="unlockPersonBtn" onclick="unlockPerson()" disabled>üîì Unlock Person</button>
          <button id="trackPersonBtn" onclick="trackPersonWithDrone()" disabled>üéØ Center Person with Drone</button>
        </div>
        <div id="trackingInfo" class="tracking-info">
          <p>Lock onto a person to enable drone tracking</p>
        </div>
      </div>
      
      <p id="cameraStatus">Camera controls for human detection and tracking integration.</p>
      <div class="button-group">
        <button id="toggleCameraBtn" onclick="toggleCamera()" class="control-btn">üìπ Enable Camera</button>
      </div>
    </div>

    <!-- Basic Drone Controls -->
    <div class="section">
      <h2>Basic Drone Controls</h2>
      <div class="controls">
        <div class="button-group">
          <button id="takeoffBtn" onclick="droneTakeoff()" class="takeoff-btn">üöÅ TAKEOFF (5 feet)</button>
          <button id="landBtn" onclick="droneLand()" class="land-btn">üõ¨ LAND</button>
        </div>
      </div>
      <p id="basicControlStatus">Use these controls for basic takeoff and landing operations.</p>
    </div>

    <!-- System Logs -->
    <div class="section">
      <h2>System Logs</h2>
      <div class="controls">
        <div class="button-group">
          <button id="clearLogsBtn" onclick="clearSystemLogs()" class="clear-btn">üóëÔ∏è Clear Logs</button>
          <label>
            <input type="checkbox" id="autoScrollLogs" checked> Auto-scroll logs
          </label>
        </div>
      </div>
      <div id="logDisplay" class="log-display">
        <div class="log-message">System ready - logs will appear here...</div>
      </div>
    </div>
  </div>

  <script>
    let isUserTracking = false;
    let isDroneTracking = false;
    let isDroneFollowing = false;
    let watchId = null;
    let intervalId = null;
    let statusUpdateId = null;
    let logUpdateId = null;
    let lastKnownPosition = null;
    
    // Camera variables
    let cameraActive = false;
    let detectionInterval = null;
    let cameraFeedInterval = null;

    const userStatus = document.getElementById("userStatus");
    const droneStatus = document.getElementById("droneStatus");
    const followStatus = document.getElementById("followStatus");
    const basicControlStatus = document.getElementById("basicControlStatus");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const droneStartBtn = document.getElementById("droneStartBtn");
    const droneStopBtn = document.getElementById("droneStopBtn");
    const followStartBtn = document.getElementById("followStartBtn");
    const followStopBtn = document.getElementById("followStopBtn");
    const homeBtn = document.getElementById("homeBtn");
    const takeoffBtn = document.getElementById("takeoffBtn");
    const landBtn = document.getElementById("landBtn");
    const clearLogsBtn = document.getElementById("clearLogsBtn");
    const logDisplay = document.getElementById("logDisplay");
    const autoScrollLogs = document.getElementById("autoScrollLogs");
    
    // Camera elements
    const startCameraBtn = document.getElementById("startCameraBtn");
    const stopCameraBtn = document.getElementById("stopCameraBtn");
    const toggleBoxesBtn = document.getElementById("toggleBoxesBtn");
    const cameraFeed = document.getElementById("cameraFeed");
    const cameraPlaceholder = document.getElementById("cameraPlaceholder");
    const detectionCount = document.getElementById("detectionCount");
    const lockedPerson = document.getElementById("lockedPerson");
    const boxStatus = document.getElementById("boxStatus");
    const personList = document.getElementById("personList");
    const unlockPersonBtn = document.getElementById("unlockPersonBtn");
    const trackPersonBtn = document.getElementById("trackPersonBtn");
    const trackingInfo = document.getElementById("trackingInfo");
    const cameraStatus = document.getElementById("cameraStatus");

    function updateUserStatus(message, className) {
      userStatus.textContent = message;
      userStatus.className = className;
    }

    function updateDroneStatus(message, className) {
      droneStatus.textContent = message;
      droneStatus.className = className;
    }

    function updateFollowStatus(message, className) {
      followStatus.textContent = message;
      followStatus.className = className;
    }

    function updateBasicControlStatus(message, className) {
      basicControlStatus.textContent = message;
      basicControlStatus.className = className;
    }

    function updateLiveStatus() {
      fetch("http://localhost:5000/status")
        .then(res => res.json())
        .then(data => {
          // Update user location display
          if (data.user_has_location) {
            document.getElementById("userLocation").textContent = 
              `${data.user_location.lat.toFixed(6)}, ${data.user_location.lon.toFixed(6)}`;
          } else {
            document.getElementById("userLocation").textContent = "Not available";
          }

          // Update GPS source display
          const gpsSourceElement = document.getElementById("gpsSource");
          if (data.gps_source && data.gps_status) {
            gpsSourceElement.textContent = data.gps_status;
            
            // Color code based on GPS health
            gpsSourceElement.className = '';
            if (data.gps_health === 'excellent') {
              gpsSourceElement.style.color = '#27ae60'; // Green
            } else if (data.gps_health === 'good') {
              gpsSourceElement.style.color = '#f39c12'; // Orange
            } else if (data.gps_health === 'poor') {
              gpsSourceElement.style.color = '#e74c3c'; // Red
            } else if (data.gps_health === 'fair') {
              gpsSourceElement.style.color = '#3498db'; // Blue
            } else if (data.gps_health === 'manual') {
              gpsSourceElement.style.color = '#9b59b6'; // Purple
            } else {
              gpsSourceElement.style.color = '#7f8c8d'; // Gray
            }
          } else {
            gpsSourceElement.textContent = "No GPS source";
            gpsSourceElement.style.color = '#7f8c8d';
          }

          // Update drone location display
          if (data.drone_has_location) {
            document.getElementById("droneLocation").textContent = 
              `${data.drone_location.lat.toFixed(6)}, ${data.drone_location.lon.toFixed(6)}`;
          } else {
            document.getElementById("droneLocation").textContent = "Not available";
          }

          // Update distance display
          if (data.user_has_location && data.drone_has_location && data.distance_meters > 0) {
            document.getElementById("distance").textContent = 
              `${data.distance_meters}m (${data.distance_feet}ft)`;
          } else {
            document.getElementById("distance").textContent = "Not calculated";
          }

          // Update follow mode display
          const followModeText = data.follow_mode ? 
            `Active (${data.target_elevation}m elevation, ${data.target_distance}m distance)` : 
            "Inactive";
          document.getElementById("followMode").textContent = followModeText;
          
          // Update camera status and toggle button
          const cameraStatus = document.getElementById('cameraStatus');
          const toggleCameraBtn = document.getElementById('toggleCameraBtn');
          
          if (data.camera_enabled !== undefined) {
            if (data.camera_enabled) {
              if (data.camera_running) {
                cameraStatus.textContent = 'üìπ Live camera stream active';
                cameraStatus.className = 'status-success';
              } else {
                cameraStatus.textContent = 'üìπ Camera enabled but not running';
                cameraStatus.className = 'status-warning';
              }
              toggleCameraBtn.textContent = 'üìπ Disable Camera';
            } else {
              cameraStatus.textContent = 'üìπ Camera disabled';
              cameraStatus.className = 'status-info';
              toggleCameraBtn.textContent = 'üìπ Enable Camera';
            }
          }
        })
        .catch(error => {
          console.error("Error updating status:", error);
        });
    }

    function updateSystemLogs() {
      fetch("http://localhost:5000/logs")
        .then(res => res.json())
        .then(data => {
          const logs = data.logs || [];
          if (logs.length > 0) {
            logDisplay.innerHTML = '';
            logs.forEach(log => {
              const logElement = document.createElement('div');
              logElement.className = `log-message ${log.level} ${log.component}`;
              logElement.textContent = `[${log.timestamp}] ${log.level} - ${log.component}: ${log.message}`;
              logDisplay.appendChild(logElement);
            });
            
            // Auto-scroll to bottom if enabled
            if (autoScrollLogs.checked) {
              logDisplay.scrollTop = logDisplay.scrollHeight;
            }
          }
        })
        .catch(error => {
          console.error("Error updating logs:", error);
        });
    }

    function clearSystemLogs() {
      if (confirm("Are you sure you want to clear all system logs?")) {
        fetch("http://localhost:5000/logs/clear", {
          method: "POST"
        })
          .then(res => res.json())
          .then(data => {
            logDisplay.innerHTML = '<div class="log-message">Logs cleared - new logs will appear here...</div>';
          })
          .catch(error => {
            console.error("Error clearing logs:", error);
          });
      }
    }

    // Camera control functions
    function restartCamera() {
      const cameraStatus = document.getElementById('cameraStatus');
      cameraStatus.textContent = 'üîÑ Restarting camera...';
      cameraStatus.className = 'status-warning';
      
      fetch('http://localhost:5000/camera/restart', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            cameraStatus.textContent = 'Failed to restart camera: ' + data.error;
            cameraStatus.className = 'status-error';
            alert('Error restarting camera: ' + data.error);
          } else {
            cameraStatus.textContent = 'üìπ Camera restarted - live stream active';
            cameraStatus.className = 'status-success';
            console.log('Camera restarted successfully');
          }
        })
        .catch(error => {
          console.error('Error restarting camera:', error);
          cameraStatus.textContent = 'Failed to restart camera';
          cameraStatus.className = 'status-error';
        });
    }

    function toggleCamera() {
      const cameraStatus = document.getElementById('cameraStatus');
      const toggleBtn = document.getElementById('toggleCameraBtn');
      
      cameraStatus.textContent = 'üîÑ Toggling camera...';
      cameraStatus.className = 'status-warning';
      toggleBtn.disabled = true;
      
      fetch('http://localhost:5000/camera/toggle', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            cameraStatus.textContent = 'Failed to toggle camera: ' + data.error;
            cameraStatus.className = 'status-error';
            alert('Error toggling camera: ' + data.error);
          } else {
            if (data.camera_enabled) {
              cameraStatus.textContent = 'üìπ Camera enabled - live stream active';
              cameraStatus.className = 'status-success';
              toggleBtn.textContent = 'üìπ Disable Camera';
              cameraActive = true;
              
              // Show camera feed, hide placeholder
              const cameraFeed = document.getElementById('cameraFeed');
              const cameraPlaceholder = document.getElementById('cameraPlaceholder');
              cameraFeed.style.display = 'block';
              cameraPlaceholder.style.display = 'none';
              
              // Start camera feed and detection updates
              startCameraFeed();
              startDetectionUpdates();
            } else {
              cameraStatus.textContent = 'üìπ Camera disabled';
              cameraStatus.className = 'status-info';
              toggleBtn.textContent = 'üìπ Enable Camera';
              cameraActive = false;
              
              // Stop camera feed and detection updates
              stopCameraFeed();
              stopDetectionUpdates();
              
              // Clear the camera feed when disabled
              const cameraFeed = document.getElementById('cameraFeed');
              const cameraPlaceholder = document.getElementById('cameraPlaceholder');
              cameraFeed.style.display = 'none';
              cameraFeed.src = ''; // Clear the image source
              cameraPlaceholder.style.display = 'block';
              cameraPlaceholder.innerHTML = '<p>üìπ Camera disabled</p>';
            }
            console.log('Camera toggled:', data.camera_enabled ? 'enabled' : 'disabled');
          }
        })
        .catch(error => {
          console.error('Error toggling camera:', error);
          cameraStatus.textContent = 'Failed to toggle camera';
          cameraStatus.className = 'status-error';
        })
        .finally(() => {
          toggleBtn.disabled = false;
        });
    }

    function initializeLiveStream() {
      // Check camera status from server first
      fetch('http://localhost:5000/camera/status')
        .then(response => response.json())
        .then(data => {
          const cameraFeed = document.getElementById('cameraFeed');
          const cameraPlaceholder = document.getElementById('cameraPlaceholder');
          const cameraStatus = document.getElementById('cameraStatus');
          const toggleBtn = document.getElementById('toggleCameraBtn');
          
          if (data.camera_enabled) {
            // Camera is enabled, start the feed
            cameraActive = true;
            
            // Show camera feed, hide placeholder
            cameraFeed.style.display = 'block';
            cameraPlaceholder.style.display = 'none';
            
            // Start camera feed and detection updates
            startCameraFeed();
            startDetectionUpdates();
            
            // Update status and button
            cameraStatus.textContent = 'üìπ Live camera stream active';
            cameraStatus.className = 'status-success';
            toggleBtn.textContent = 'üìπ Disable Camera';
          } else {
            // Camera is disabled, show placeholder
            cameraActive = false;
            
            cameraFeed.style.display = 'none';
            cameraPlaceholder.style.display = 'block';
            
            // Update status and button
            cameraStatus.textContent = 'üì∑ Camera disabled';
            cameraStatus.className = 'status-warning';
            toggleBtn.textContent = 'üìπ Enable Camera';
          }
          
          console.log('Live camera stream initialized - Camera enabled:', data.camera_enabled);
        })
        .catch(error => {
          console.error('Error checking camera status:', error);
          // Default to disabled state on error
          cameraActive = false;
          const cameraFeed = document.getElementById('cameraFeed');
          const cameraPlaceholder = document.getElementById('cameraPlaceholder');
          const cameraStatus = document.getElementById('cameraStatus');
          
          cameraFeed.style.display = 'none';
          cameraPlaceholder.style.display = 'block';
          cameraStatus.textContent = '‚ö†Ô∏è Camera status check failed';
          cameraStatus.className = 'status-error';
        });
    }

    function startCameraFeed() {
      cameraFeedInterval = setInterval(() => {
        if (cameraActive) {
          fetch('http://localhost:5000/camera/feed')
            .then(response => response.json())
            .then(data => {
              if (data.frame && data.frame.length > 50) {
                const cameraFeed = document.getElementById('cameraFeed');
                cameraFeed.src = data.frame;
              }
            })
            .catch(error => console.error('Error getting camera feed:', error));
        }
      }, 100); // 10 FPS for web display
    }

    function startDetectionUpdates() {
      detectionInterval = setInterval(() => {
        if (cameraActive) {
          fetch('http://localhost:5000/camera/detections')
            .then(response => response.json())
            .then(data => {
              updateDetectionUI(data);
            })
            .catch(error => console.error('Error getting detections:', error));
        }
      }, 500); // Update every 500ms
    }

    function stopCameraFeed() {
      if (cameraFeedInterval !== null) {
        clearInterval(cameraFeedInterval);
        cameraFeedInterval = null;
      }
    }

    function stopDetectionUpdates() {
      if (detectionInterval !== null) {
        clearInterval(detectionInterval);
        detectionInterval = null;
      }
    }

    function updateDetectionUI(data) {
      // Update detection count
      detectionCount.textContent = data.detections.length;
      
      // Update locked person
      lockedPerson.textContent = 
        data.locked_person !== null ? `Person ${data.locked_person}` : 'None';
      
      // Update bounding box status
      boxStatus.textContent = data.show_boxes ? 'ON' : 'OFF';
      
      // Update person list
      if (data.detections.length === 0) {
        personList.innerHTML = '<p>No persons detected</p>';
      } else {
        personList.innerHTML = data.detections.map(person => `
          <div class="person-item ${data.locked_person === person.id ? 'locked' : ''}">
            <div class="person-info">Person ${person.id} (${(person.confidence * 100).toFixed(1)}%)</div>
            <button onclick="lockPerson(${person.id})" class="lock-btn ${data.locked_person === person.id ? 'unlock' : 'lock'}">
              ${data.locked_person === person.id ? 'üîí Locked' : 'üîì Lock'}
            </button>
          </div>
        `).join('');
      }
      
      // Enable/disable controls based on locked person
      const hasLockedPerson = data.locked_person !== null;
      unlockPersonBtn.disabled = !hasLockedPerson;
      trackPersonBtn.disabled = !hasLockedPerson;
      
      // Update tracking info
      if (hasLockedPerson) {
        trackingInfo.innerHTML = `<p>‚úÖ Tracking Person ${data.locked_person}. Click "Center Person with Drone" to adjust drone position.</p>`;
      } else {
        trackingInfo.innerHTML = '<p>üí° Lock onto a person to enable drone tracking</p>';
      }
    }

    function lockPerson(personId) {
      fetch(`http://localhost:5000/camera/lock/${personId}`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert('Error locking person: ' + data.error);
          } else {
            console.log(`Locked onto person ${personId}`);
          }
        })
        .catch(error => console.error('Error locking person:', error));
    }

    function unlockPerson() {
      fetch('http://localhost:5000/camera/unlock', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          console.log('Unlocked from person');
        })
        .catch(error => console.error('Error unlocking person:', error));
    }

    function toggleBoundingBoxes() {
      fetch('http://localhost:5000/camera/toggle_boxes', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          console.log('Bounding boxes toggled:', data.show_boxes);
        })
        .catch(error => console.error('Error toggling boxes:', error));
    }

    function trackPersonWithDrone() {
      fetch('http://localhost:5000/drone/track_person', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert('Error tracking person: ' + data.error);
          } else {
            console.log('Drone tracking adjustment:', data.adjustments);
            // Show feedback in tracking info
            const adj = data.adjustments;
            trackingInfo.innerHTML = `
              <p>üéØ TESTING MODE: Calculated adjustments</p>
              <p>Yaw: ${adj.yaw_adjustment?.toFixed(1) || 0}¬∞, Pitch: ${adj.pitch_adjustment?.toFixed(1) || 0}¬∞</p>
              <p>Person center: ${adj.person_center ? `(${adj.person_center[0]}, ${adj.person_center[1]})` : 'N/A'}</p>
              <p>Frame center: ${adj.frame_center ? `(${adj.frame_center[0]}, ${adj.frame_center[1]})` : 'N/A'}</p>
            `;
          }
        })
        .catch(error => console.error('Error tracking with drone:', error));
    }

    function sendLocationToServer(latitude, longitude) {
      const data = {
        latitude: latitude,
        longitude: longitude,
      };

      fetch("http://localhost:5000/location", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      })
        .then((res) => res.text())
        .then((text) => {
          if (isUserTracking) {
            updateUserStatus(`User tracking active: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`, "status-sending");
          }
        })
        .catch((error) => {
          console.error("Error sending location:", error);
          if (isUserTracking) {
            updateUserStatus(`Error sending location: ${error.message}`, "status-error");
          }
        });
    }

    function startLocationTracking() {
      if (!navigator.geolocation) {
        updateUserStatus("Geolocation is not supported by this browser.", "status-error");
        return;
      }

      isUserTracking = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      updateUserStatus("Getting location...", "status-sending");

      navigator.geolocation.getCurrentPosition(
        (position) => {
          lastKnownPosition = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
          };
          updateUserStatus("Location acquired successfully", "status-success");
          sendLocationToServer(lastKnownPosition.latitude, lastKnownPosition.longitude);

          // Start watching for position changes
          watchId = navigator.geolocation.watchPosition(
            (position) => {
              lastKnownPosition = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude
              };
              sendLocationToServer(lastKnownPosition.latitude, lastKnownPosition.longitude);
            },
            (error) => {
              console.error("Geolocation error:", error);
              updateUserStatus("Location error: " + error.message, "status-error");
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 30000
            }
          );

          // Send location every 3 seconds
          intervalId = setInterval(() => {
            if (isUserTracking && lastKnownPosition) {
              sendLocationToServer(lastKnownPosition.latitude, lastKnownPosition.longitude);
            }
          }, 3000);
        },
        (error) => {
          console.error("Geolocation error:", error);
          updateUserStatus("Location error: " + error.message, "status-error");
          isUserTracking = false;
          startBtn.disabled = false;
          stopBtn.disabled = true;
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    }

    function stopLocationTracking() {
      isUserTracking = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;

      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }

      if (intervalId !== null) {
        clearInterval(intervalId);
        intervalId = null;
      }

      updateUserStatus("User location tracking stopped.", "status-stopped");
    }

    function startDroneTracking() {
      fetch("http://localhost:5000/drone/start", {
        method: "POST"
      })
        .then(res => res.json())
        .then(data => {
          isDroneTracking = true;
          droneStartBtn.disabled = true;
          droneStopBtn.disabled = false;
          updateDroneStatus("Drone tracking started - monitoring Pixhawk location", "status-sending");
        })
        .catch(error => {
          console.error("Error starting drone tracking:", error);
          updateDroneStatus(`Error starting drone tracking: ${error.message}`, "status-error");
        });
    }

    function stopDroneTracking() {
      fetch("http://localhost:5000/drone/stop", {
        method: "POST"
      })
        .then(res => res.json())
        .then(data => {
          isDroneTracking = false;
          droneStartBtn.disabled = false;
          droneStopBtn.disabled = true;
          updateDroneStatus("Drone tracking stopped.", "status-stopped");
        })
        .catch(error => {
          console.error("Error stopping drone tracking:", error);
          updateDroneStatus(`Error stopping drone tracking: ${error.message}`, "status-error");
        });
    }

    function startDroneFollow() {
      const elevation = document.getElementById("elevation").value;
      const distance = document.getElementById("groundDistance").value;

      if (!elevation || !distance) {
        updateFollowStatus("Please enter elevation and distance values", "status-error");
        return;
      }

      const data = {
        elevation: parseInt(elevation),
        distance: parseInt(distance)
      };

      updateFollowStatus("Starting drone follow mode - taking off...", "status-sending");
      followStartBtn.disabled = true;

      fetch("http://localhost:5000/drone/follow/start", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      })
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            updateFollowStatus(`Error: ${data.error}`, "status-error");
            followStartBtn.disabled = false;
          } else {
            isDroneFollowing = true;
            followStopBtn.disabled = false;
            homeBtn.disabled = false;
            updateFollowStatus(`Follow mode active - Elevation: ${data.elevation}m, Distance: ${data.distance}m`, "status-sending");
          }
        })
        .catch(error => {
          console.error("Error starting drone follow:", error);
          updateFollowStatus(`Error starting follow mode: ${error.message}`, "status-error");
          followStartBtn.disabled = false;
        });
    }

    function stopDroneFollow() {
      fetch("http://localhost:5000/drone/follow/stop", {
        method: "POST"
      })
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            updateFollowStatus(`Error: ${data.error}`, "status-error");
          } else {
            isDroneFollowing = false;
            followStartBtn.disabled = false;
            followStopBtn.disabled = true;
            updateFollowStatus("Follow mode stopped - drone hovering in place", "status-stopped");
          }
        })
        .catch(error => {
          console.error("Error stopping drone follow:", error);
          updateFollowStatus(`Error stopping follow mode: ${error.message}`, "status-error");
        });
    }

    function droneHome() {
      if (confirm("Are you sure you want to land the drone? This will stop all tracking and land immediately.")) {
        fetch("http://localhost:5000/drone/home", {
          method: "POST"
        })
          .then(res => res.json())
          .then(data => {
            if (data.error) {
              updateFollowStatus(`Error: ${data.error}`, "status-error");
            } else {
              isDroneFollowing = false;
              followStartBtn.disabled = false;
              followStopBtn.disabled = true;
              homeBtn.disabled = true;
              updateFollowStatus("Drone landing initiated - homing complete", "status-stopped");
            }
          })
          .catch(error => {
            console.error("Error landing drone:", error);
            updateFollowStatus(`Error landing drone: ${error.message}`, "status-error");
          });
      }
    }

    function droneTakeoff() {
      updateBasicControlStatus("Initiating takeoff to 5 feet...", "status-sending");
      takeoffBtn.disabled = true;

      fetch("http://localhost:5000/drone/takeoff", {
        method: "POST"
      })
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            updateBasicControlStatus(`Takeoff error: ${data.error}`, "status-error");
            takeoffBtn.disabled = false;
          } else {
            updateBasicControlStatus(`${data.status}`, "status-sending");
            landBtn.disabled = false;
            setTimeout(() => {
              takeoffBtn.disabled = false;
            }, 10000); // Re-enable after 10 seconds
          }
        })
        .catch(error => {
          console.error("Error during takeoff:", error);
          updateBasicControlStatus(`Takeoff error: ${error.message}`, "status-error");
          takeoffBtn.disabled = false;
        });
    }

    function droneLand() {
      if (confirm("Are you sure you want to land the drone at its current location?")) {
        updateBasicControlStatus("Initiating landing...", "status-sending");
        landBtn.disabled = true;

        fetch("http://localhost:5000/drone/land", {
          method: "POST"
        })
          .then(res => res.json())
          .then(data => {
            if (data.error) {
              updateBasicControlStatus(`Landing error: ${data.error}`, "status-error");
              landBtn.disabled = false;
            } else {
              updateBasicControlStatus(`${data.status}`, "status-stopped");
              takeoffBtn.disabled = false;
              setTimeout(() => {
                landBtn.disabled = false;
              }, 5000); // Re-enable after 5 seconds
            }
          })
          .catch(error => {
            console.error("Error during landing:", error);
            updateBasicControlStatus(`Landing error: ${error.message}`, "status-error");
            landBtn.disabled = false;
          });
      }
    }

    // Initialize live camera stream on page load
    initializeLiveStream();

    // Start live status updates every 2 seconds
    statusUpdateId = setInterval(updateLiveStatus, 2000);
    
    // Start log updates every 3 seconds
    logUpdateId = setInterval(updateSystemLogs, 3000);

    // Handle page unload to stop tracking
    window.addEventListener('beforeunload', () => {
      if (isUserTracking) {
        stopLocationTracking();
      }
      if (isDroneTracking) {
        stopDroneTracking();
      }
      if (statusUpdateId) {
        clearInterval(statusUpdateId);
      }
      if (logUpdateId) {
        clearInterval(logUpdateId);
      }
    });

    // Initial status and log update
    updateLiveStatus();
    updateSystemLogs();
  </script>
</body>
</html>
